# Docker приложение с именованным томом

## Зачем?
Распространенная ситуация. Создаешь в докере php/js приложение где есть один исполнющий контейнер и все круто, пока не припрет прикрутить брокеры очередей, контейнер с миграциями, другими словами кучу реплик клонов основного контейнера с идентичной кодовой базой.

## Почему не скопировать?
Скопировали. Получили повторение билда на каждый контейнера, плюс повышенное потребление ресурсов.

## Выход (решение)
Создать именованный том, сбилдить (установить зависимости, выполнить миграции, прогреть кэш и тд.) туда один раз прилагу и расшарить готовый код на все использующие контейнеры. Для прода пойдет.

## А что с процессом разработки ?
После билда новый код попадет в том только после перезапуска. Смонтировать папку с кодом на именованный том не получится. И как кодить? Никак! Расходимся. Шучу.

## Решение для разработки
Создать для дев среды контейнер, смонтировать папку с исходным кодом проекта, например в /tmp/app_source, и прикрутить именованный том на другую папку, например на /tmp/app и натравить rsync на синхронизацию папок. А запустить это в непрерывном режиме поможет утилита inotifywait из пакета inotify-tools. 

## Как это работает
Вносишь изменение в код. Docker копирует изменения в /tmp/app_source. inotifywait видит изменения в файлах и запускает rsync, rsync копирует изменения в /tmp/app, docker копирует изменения в расшаренный том, изменения попадают во все использующие том контейнеры.

## Пользуйтесь на здоровье

## P.S.
Здесь rsync работает в режиме доабвления, он не удаляет то чего нет в исходном коде, это нужно чтобы rsync не затирал папку vendor и прочие сгенерированные файлы.
При желании это можно поменять.
Как очищать общий том найдете в инете. (docker-compose down -v)
